import math
import pandas as pd
from settings import DATA_DIR


class SeasonalTransitions:
    """
    This will take the current params and the current timestep and returns the updated params based on the timestep.
    """

    def __init__(self):
        self.covid_data = pd.read_csv(f"{DATA_DIR}/Updated Data/epidemiological_model_data/new_york.csv")
        self.vfv = self.covid_data['percentage_unvaccinated_to_fully_vaccinated']
        self.vb = self.covid_data['percentage_fully_vaccinated_to_boosted']

        self.baselines = {
            "alpha": [
                0.9921061737800656,
                0.999999999999382,
                0.9997006558362771,
                0.9968623277813831,
                0.9999999976899998,
                0.9999999999934777,
                0.9999832708276221,
                0.9999977204877676,
                0.999990484796472,
                0.9999998603343343,
                0.9999994613134795,
                0.8667971932071317,
                0.9987829564173087,
                0.9242816529512278,
                0.8913601714594757,
            ],
            "beta": [
                4.979203079794559,
                4.97458653699875,
                4.998978463651875,
                4.150487813293975,
                4.999575013079198,
                4.99997112741788,
                4.878199450296301,
                4.902405795261032,
                4.999999999999789,
                3.3489137022430944,
                4.999972601990617,
                3.6779583437607575,
                1.6469992682905124,
                2.129861260361653,
                4.204429178608633,
            ],
            "e_s": {  # sigma_s
                "uv": [
                    0.2797044028880083,
                    0.34431409936925694,
                    0.3580504182316429,
                    0.1166177252469825,
                    0.16997197499388433,
                    0.23405769641743218,
                    0.2769261712186397,
                    0.2566061899692816,
                    0.174547479075425,
                    0.0,
                    0.15547516429999247,
                    0.02161976137750099,
                    0.00810782879033839,
                    0.0018613327530079271,
                    2.7699159632632586e-10,
                ],
                "fv": [
                    0.2662392505973987,
                    0.33212344139038685,
                    0.3261725159472545,
                    0.1490687843082517,
                    0.17262913177692407,
                    0.2511983728144259,
                    0.29030016577761925,
                    0.26604931009425203,
                    0.19978065051003357,
                    0.019989520104101544,
                    0.29600857702146344,
                    0.09553721531017201,
                    0.03525179288803204,
                    0.013619697748734672,
                    0.2665718014138282,
                ],
                "b": [
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.14985202566588945,
                    0.21973900778289351,
                    0.2599201628582599,
                    0.20235521660244826,
                    0.021243110081864858,
                    0.3154426026890688,
                    0.07282721934828185,
                    0.06104703495295127,
                    0.014707636143268588,
                    0.23840873738908486,
                ],
            },
            "e_i": {  # zeta_s
                "uv": [
                    0.0007318991017170318,
                    0.0011574000234550435,
                    0.0017036948546286818,
                    0.004362887453730158,
                    0.013457377607078725,
                    0.006346703985227398,
                    0.011831358692383566,
                    0.01252818896039103,
                    0.020312861456003757,
                    0.033087401587158706,
                    0.01400141647252155,
                    0.0008811232498273897,
                    0.049999988741923546,
                    0.04999999994431923,
                    6.647410305418711e-06,
                ],
                "fv": [
                    6.1106906552897415e-06,
                    0.00013962269248590849,
                    0.00027731392827476555,
                    0.0008033915116582933,
                    0.0013398147739391419,
                    0.0006858134315300495,
                    0.00034256391767068574,
                    0.0003035016049242131,
                    0.00046329586694962636,
                    0.0011518632138663876,
                    5.289629342576374e-07,
                    2.5765181231485192e-08,
                    0.00015346896176303293,
                    0.00031249562807744675,
                    1.929435442860061e-09,
                ],
                "b": [
                    0.0003000000000000001,
                    0.0003000000000000001,
                    0.0003000000000000001,
                    0.0003000000000000001,
                    0.0003000000000000001,
                    0.001149491404118182,
                    0.004036702171532546,
                    3.397575846220136e-10,
                    0.0001682986024646966,
                    0.000999212015626945,
                    0.00019274732954734208,
                    5.880573818801605e-05,
                    0.0009881243669758186,
                    0.001658550667957768,
                    0.0005631708299375719,
                ],
            },
            "i_r": {  # gamma_i
                "uv": [
                    0.05454324458277713,
                    0.054999999999984624,
                    0.05493914662841438,
                    0.05499990759397898,
                    0.05499806747662576,
                    0.04100138873053479,
                    0.05477290137597402,
                    0.053825419002336575,
                    0.054529234511264964,
                    0.04000000000000034,
                    0.046392374251813036,
                    0.054999713367516335,
                    0.04000004218536563,
                    0.0400000026033707,
                    0.04012178719368275,
                ],
                "fv": [
                    0.05499214815619127,
                    0.051716264016610655,
                    0.05496900364583629,
                    0.05461994710842431,
                    0.05499999997555863,
                    0.04747274559193559,
                    0.05326993709415978,
                    0.054999468572432986,
                    0.05499999748127864,
                    0.045000001732971695,
                    0.052260588208621334,
                    0.054998278481102426,
                    0.045000030630856995,
                    0.05443487833553049,
                    0.05474162345518843,
                ],
                "b": [
                    0.053,
                    0.053,
                    0.053,
                    0.053,
                    0.053,
                    0.053,
                    0.047527421385129165,
                    0.047512182262614014,
                    0.04753550670362312,
                    0.047500000000000084,
                    0.06175487524141818,
                    0.06499802339400954,
                    0.047500619893717684,
                    0.04753664736862204,
                    0.06291341416198146,
                ],
            },
            "i_h": {  # delta
                "uv": [
                    0.0025502796914869566,
                    1.1927977532355527e-14,
                    0.00033590586973677593,
                    0.004439027683949327,
                    0.004444439879977823,
                    0.004438688228942953,
                    0.003410784678446129,
                    0.0019063365305083818,
                    0.002738613153107736,
                    0.0031973457209689992,
                    0.0012563474592947861,
                    0.0015391354807226135,
                    0.0003191149877727051,
                    0.0028976182507645257,
                    0.0009689996872575844,
                ],
                "fv": [
                    0.0013644550830824043,
                    7.998410292233626e-10,
                    0.004441947264565481,
                    0.00310033406963474,
                    0.003111528871142363,
                    0.0021878944815369207,
                    0.003842754738498646,
                    3.0471233519136476e-05,
                    0.0008992145473468121,
                    0.000546659225923523,
                    0.0004165955972560249,
                    0.00040581377314839235,
                    0.0012433423734815078,
                    0.0029025653261004203,
                    0.0013589929204257342,
                ],
                "b": [
                    0.000516666,
                    0.000516666,
                    0.000516666,
                    0.000516666,
                    0.000516666,
                    0.000516666,
                    0.004435513215501976,
                    0.0008285269025012719,
                    0.0010351714630686705,
                    0.00035536520680206913,
                    0.000436249724771229,
                    0.0003222169211899946,
                    0.00028863269709794153,
                    0.0011291977574560646,
                    0.0004754980986263272,
                ],
            },
            "i_d": {  # mu_i
                "uv": [
                    0.0011898381320066536,
                    0.0016461696490861401,
                    5.557756084789282e-05,
                    0.0025929773893008544,
                    0.003332580613624076,
                    0.00038434227102280644,
                    0.0014475754401885475,
                    0.0006446404408645657,
                    0.00045090847272443433,
                    5.5555550000155024e-05,
                    0.0002842322533048449,
                    0.0033331446010170136,
                    0.0001346545061541397,
                    0.00016510386851820654,
                    0.001174139354820452,
                ],
                "fv": [
                    0.000968991153713453,
                    0.0008031958184529309,
                    5.555555000134667e-06,
                    0.0007799791561391193,
                    0.00012356244610305732,
                    0.00028252658788236753,
                    0.0009695630490258248,
                    0.0007025163121404912,
                    0.0005389402123607347,
                    0.00022287710504662042,
                    0.0003852112799188121,
                    0.0028162301234761593,
                    1.658517276642031e-05,
                    0.00012902217569051903,
                    0.00020343028748589007,
                ],
                "b": [
                    5.555555000000009e-06,
                    5.555555000000009e-06,
                    5.555555000000009e-06,
                    5.555555000000009e-06,
                    5.555555000000009e-06,
                    5.555555000000009e-06,
                    0.00023056307212302528,
                    0.00016819448709593123,
                    3.36418613048688e-05,
                    0.0002482277445804881,
                    0.0003162945618154334,
                    0.0012679416366859486,
                    0.000820640351487956,
                    1.709677015416232e-05,
                    0.00017848713214707823,
                ],
            },
            "e2_i": {  # zeta_r
                "uv": [
                    0.0024909333130088587,
                    0.0007187527866670652,
                    0.00023545233240417074,
                    0.0057906673455601744,
                    6.310338210774314e-07,
                    0.0011364601214976788,
                    0.00063194566537908,
                    1.2389820280844788e-10,
                    2.420593336882604e-09,
                    0.0033726612629533664,
                    8.856118519284806e-06,
                    5.118492442954259e-06,
                    0.04999942155546967,
                    0.049999999998551835,
                    1.127830620561987e-08,
                ],
                "fv": [
                    0.0006450657128552588,
                    1.2115125569422958e-13,
                    2.265172591711384e-06,
                    0.00021820919238626935,
                    1.872674237901606e-12,
                    4.2976049414082955e-06,
                    2.0901160795103735e-06,
                    6.318968785489765e-07,
                    1.0528939442533414e-10,
                    2.8798764222455142e-05,
                    0.0003786947524119257,
                    1.621949413471713e-08,
                    0.00022645875956498336,
                    0.000495940501522658,
                    0.000724824228763912,
                ],
                "b": [
                    0.004,
                    0.004,
                    0.004,
                    0.004,
                    0.004,
                    0.006979005796484052,
                    0.0010701088453985836,
                    0.0013051640745155204,
                    0.0006450084026508098,
                    0.0010040242434811648,
                    0.0005112768916504632,
                    7.871312454313601e-05,
                    0.0009921237117573275,
                    0.0015537442266259076,
                    0.002874814750625074,
                ],
            },
            "h_r": {  # gamma_h
                "uv": [
                    0.03467454100259981,
                    0.025387756477381746,
                    0.025004448376817784,
                    0.02761422403317452,
                    0.025000000000236458,
                    0.05251118105209822,
                    0.0549110466748263,
                    0.033067036304681066,
                    0.025000016934706253,
                    0.05499999999986076,
                    0.04197826269230298,
                    0.04834864909249086,
                    0.026320057827536415,
                    0.02500001559861162,
                    0.025028212484802824,
                ],
                "fv": [
                    0.030290563140145815,
                    0.030000000000000207,
                    0.03185761802081461,
                    0.04204778355488563,
                    0.05354273969484376,
                    0.054191972978106906,
                    0.04554706163804386,
                    0.030000011314920128,
                    0.03038156224719357,
                    0.05499999999999999,
                    0.04614880587376313,
                    0.04269476504178644,
                    0.03418548843830638,
                    0.030676406640121834,
                    0.03000935720574363,
                ],
                "b": [
                    0.0377777,
                    0.0377777,
                    0.0377777,
                    0.0377777,
                    0.0377777,
                    0.0377777,
                    0.05024106727480235,
                    0.06122977561546748,
                    0.03339888791458119,
                    0.030000018417240464,
                    0.05951600677771558,
                    0.04358177542024513,
                    0.03491646714746562,
                    0.06491527721233392,
                    0.04218485117522834,
                ],
            },
            "h_d": {  # mu_h
                "uv": [
                    0.0065387373871696065,
                    0.0027777723418094774,
                    0.0027777707610357793,
                    0.0027796898070118975,
                    0.002908950156740234,
                    0.002813558388157619,
                    0.007375748874639409,
                    0.0027833913951630404,
                    0.002781769011272498,
                    0.011425345371481198,
                    0.007260659510285804,
                    0.011103496703024114,
                    0.0027786870476711072,
                    0.0027777753029138794,
                    0.002778499268413278,
                ],
                "fv": [
                    0.0007779467358999902,
                    0.0036787721921557924,
                    0.012782730610475765,
                    0.0007780821739797155,
                    0.010918170242898977,
                    0.01065527161079136,
                    0.013786555042614205,
                    0.0007777747122808551,
                    0.000782712451470584,
                    0.013888879999999729,
                    0.006634152071829002,
                    0.007622872559056293,
                    0.005436367402536328,
                    0.0014393769862645256,
                    0.0007832171167080535,
                ],
                "b": [
                    0.0008777700000000002,
                    0.0008777700000000002,
                    0.0008777700000000002,
                    0.0008777700000000002,
                    0.0008777700000000002,
                    0.0008777700000000002,
                    0.00978766881560744,
                    0.013888851250363472,
                    0.0073671130602453875,
                    0.01388887999999899,
                    0.013887747182280856,
                    0.01253248402718307,
                    0.0033045026940641932,
                    0.013875288010646254,
                    0.0020271548979584873,
                ],
            },
            "e_r": {  # sigma_r
                "uv": [
                    0.03953448795218578,
                    0.058203388178277304,
                    0.032928459326050485,
                    0.0515539619520361,
                    0.034443635234412906,
                    0.059315200907886834,
                    0.07371744803997626,
                    0.08680504616510387,
                    0.09303842995851996,
                    0.09084809679551148,
                    0.9042612659047722,
                    0.7424077412987622,
                    0.9062605142439981,
                    0.9961753414307617,
                    3.271895679946013e-07,
                ],
                "fv": [
                    0.019437664121463194,
                    0.021335162733075785,
                    0.029657269748876447,
                    0.011550470005043612,
                    0.022108016565385413,
                    0.026750229515834056,
                    0.027068151213753,
                    0.032421554164926925,
                    0.02804895096106269,
                    0.018719326095313793,
                    0.06399355798909162,
                    0.03261880318624616,
                    0.03236626547518978,
                    0.0027465977594754443,
                    0.011397488403402434,
                ],
                "b": [
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.5,
                    0.36269708395031774,
                    0.0765039340194445,
                    0.04085645680385164,
                    0.0319032123657676,
                    0.01950260146638827,
                    0.0672133875063915,
                    0.05921676760645461,
                    0.00578248066924314,
                    0.0016780890594801368,
                    0.03637156804177161,
                ],
            },
        }

    def __call__(self, state):
        s = state.copy(deep=True)

        # This index helps to use the different parameter values for the different splits.
        # AD: Converts range(n) into [7 (10x), 8 (28x), 9 (28x), 10 (28x), ...]
        #     28 = 4 weeks. 214 = start date (october)
        index = math.floor((s.time_step + 214) / 28)

        for param, values in self.baselines.items():
            if type(values) is dict:
                for comp in ["uv", "fv", "b"]:
                    s.params[param][comp] = values[comp][index]
            else:
                s.params[param] = values[index]

        s.params.vfv = self.vfv.iloc[s.time_step + 214]
        s.params.vb = self.vb.iloc[s.time_step + 214]

        return s
